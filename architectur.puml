
@startuml
title IKT300 Microkernel - Implemented Components

skinparam packageStyle rectangle

package "Kernel Process" {
    [Program.cs\n(entry point)] as Main
    [KernelServer\n(connection + orchestration)] as Kernel
    [PluginRegistry\n(config + status cache)] as Registry
    [ProcessLauncher\n(dotnet exec/run)] as Launcher
    [CommandConsole\n(list/kill/start)] as ConsoleUI
    [HeartbeatMonitor\n(timeout + restart)] as Monitor
    [MessageHandler\n(handshake/heartbeat)] as Handler
    [HeartbeatLog\nkernel-heartbeats.log] as HBLog
}

package "IPC Layer" {
    [TcpListener\n(net8.0)] as Listener
    [NetworkStream] as Stream
    [System.Text.Json\nnewline framing] as Serializer
}

package "Plugins" {
    [SamplePlugin\n(Program.cs)] as Sample
    [Other configured plugin] as OtherPlugin
}

package "Shared Library" {
    [KernelConfig\n(incl. PluginConfig)] as Config
    [Message Schema\nHeader/Metadata/Payload] as Message
}

Main --> Config : Load settings
Main --> Kernel : StartAsync()
Kernel --> Registry : Track enabled plugins
Kernel --> Launcher : StartPluginProcess()
Kernel --> Monitor : Start heartbeat loop
Kernel --> ConsoleUI : Start CommandLoop()
Kernel --> Handler : ProcessMessageAsync()
Kernel --> HBLog : LogHeartbeat()

Kernel --> Listener : Begin AcceptLoop()
Listener --> Stream : Accept TcpClient
Stream --> Handler : Deliver JSON message
Handler --> Registry : Update last seen
Monitor --> Launcher : Restart missing plugin

Sample --> Listener : TCP connect
Sample --> Message : Serialize handshake/heartbeat
Sample --> Config : Optional overrides
Sample --> Kernel : Handshake + heartbeats

OtherPlugin .. Sample : follows same contract

Config --> Launcher : workingDirectory + dll path
Message --> Handler : deserialize + route

note right of Monitor
Missed heartbeat =>
kill process + relaunch
end note

note bottom of Listener
Plain TCP + newline
framing (TLS not yet implemented)
end note

@enduml
Message Format: JSON (future: Protobuf)

